-- SELECT 
--     s.SESSION_ID,
--     ARRAY_AGG(DISTINCT COALESCE(i.ITEM_NAME, 'No Item')) AS ITEM_NAMES,
--     COUNT(DISTINCT i.ITEM_NAME) AS DISTINCT_ITEMS_COUNT,
--     COALESCE(SUM(i.ADD_TO_CART_QUANTITY - i.REMOVE_FROM_CART_QUANTITY), 0) AS TOTAL_CART_QUANTITY,
--     ARRAY_AGG(DISTINCT COALESCE(p.PAGE_NAME, 'No Page')) AS PAGE_NAMES,
--     COALESCE(MAX(o.ORDER_AT_TS), '1900-01-01 00:00:00') AS ORDER_AT_TS,  -- Placeholder date
--     COALESCE(max(o.STATE), 'No Order State') AS ORDER_STATE,
--     MAX(CASE WHEN o.ORDER_ID IS NOT NULL THEN TRUE ELSE FALSE END) AS ORDER_PLACED,
--     ARRAY_AGG(DISTINCT COALESCE(s.CLIENT_ID, 'No Client ID')) AS CLIENT_IDS, 
--     MAX(s.SESSION_AT_TS) AS SESSION_AT_TS,
--     ARRAY_AGG(DISTINCT COALESCE(s.OS, 'Unknown OS')) AS OPERATING_SYSTEMS

-- FROM {{ref("base_snowflake_SESSIONS")}} AS s
-- LEFT JOIN {{ref("base_snowflake_ORDERS")}} AS o ON s.SESSION_ID = o.SESSION_ID
-- LEFT JOIN {{ref("base_snowflake_ITEM_VIEWS")}} AS i ON s.SESSION_ID = i.SESSION_ID
-- LEFT JOIN {{ref('base_snowflake_PAGE_VIEWS')}} AS p ON s.SESSION_ID = p.SESSION_ID

-- GROUP BY s.SESSION_ID



-- SELECT 
--     s.SESSION_ID,
--     ARRAY_AGG(DISTINCT COALESCE(i.ITEM_NAME, 'No Item')) AS ITEM_NAMES,
--     COUNT(DISTINCT i.ITEM_NAME) AS DISTINCT_ITEMS_COUNT,
--     COALESCE(SUM(i.ADD_TO_CART_QUANTITY - i.REMOVE_FROM_CART_QUANTITY), 0) AS TOTAL_CART_QUANTITY,
--     ARRAY_AGG(DISTINCT COALESCE(p.PAGE_NAME, 'No Page')) AS PAGE_NAMES,
--     COALESCE(MAX(o.ORDER_AT_TS), '1900-01-01 00:00:00') AS ORDER_AT_TS,
--     COALESCE(MAX(o.STATE), 'No Order State') AS ORDER_STATE,
--     MAX(CASE WHEN o.ORDER_ID IS NOT NULL THEN TRUE ELSE FALSE END) AS ORDER_PLACED,
--     ARRAY_AGG(DISTINCT COALESCE(s.CLIENT_ID, 'No Client ID')) AS CLIENT_IDS,
--     MAX(s.SESSION_AT_TS) AS SESSION_AT_TS,
--     ARRAY_AGG(DISTINCT COALESCE(s.OS, 'Unknown OS')) AS OPERATING_SYSTEMS,
--     MAX(CASE WHEN p.PAGE_NAME = 'shop_plants' THEN TRUE ELSE FALSE END) AS VISITED_SHOP_PLANTS,
--     MAX(CASE WHEN p.PAGE_NAME = 'cart' THEN TRUE ELSE FALSE END) AS VISITED_CART,
--     MAX(CASE WHEN p.PAGE_NAME = 'faq' THEN TRUE ELSE FALSE END) AS VISITED_FAQ,
--     MAX(CASE WHEN p.PAGE_NAME = 'plant_care' THEN TRUE ELSE FALSE END) AS VISITED_PLANT_CARE,
--     MAX(CASE WHEN p.PAGE_NAME = 'landing_page' THEN TRUE ELSE FALSE END) AS VISITED_LANDING_PAGE
-- FROM {{ref("base_snowflake_SESSIONS")}} AS s
-- LEFT JOIN {{ref("base_snowflake_ORDERS")}} AS o ON s.SESSION_ID = o.SESSION_ID
-- LEFT JOIN {{ref("base_snowflake_ITEM_VIEWS")}} AS i ON s.SESSION_ID = i.SESSION_ID
-- LEFT JOIN {{ref('base_snowflake_PAGE_VIEWS')}} AS p ON s.SESSION_ID = p.SESSION_ID
-- GROUP BY s.SESSION_ID

SELECT 
    s.SESSION_ID,
    ARRAY_AGG(DISTINCT COALESCE(i.ITEM_NAME, 'No Item')) AS ITEM_NAMES,
    COUNT(DISTINCT i.ITEM_NAME) AS DISTINCT_ITEMS_COUNT,
    COALESCE(SUM(i.ADD_TO_CART_QUANTITY - i.REMOVE_FROM_CART_QUANTITY), 0) AS TOTAL_CART_QUANTITY,
    ARRAY_AGG(DISTINCT COALESCE(p.PAGE_NAME, 'No Page')) AS PAGE_NAMES,
    COALESCE(MAX(o.ORDER_AT_TS), '1900-01-01 00:00:00') AS ORDER_AT_TS,
    COALESCE(MAX(o.STATE), 'No Order State') AS ORDER_STATE,
    MAX(CASE WHEN o.ORDER_ID IS NOT NULL THEN TRUE ELSE FALSE END) AS ORDER_PLACED,
    ARRAY_AGG(DISTINCT COALESCE(s.CLIENT_ID, 'No Client ID')) AS CLIENT_IDS,
    MAX(s.SESSION_AT_TS) AS SESSION_AT_TS,
    ARRAY_AGG(DISTINCT COALESCE(s.OS, 'Unknown OS')) AS OPERATING_SYSTEMS,
    MAX(CASE WHEN p.PAGE_NAME = 'shop_plants' THEN TRUE ELSE FALSE END) AS VISITED_SHOP_PLANTS,
    MAX(CASE WHEN p.PAGE_NAME = 'cart' THEN TRUE ELSE FALSE END) AS VISITED_CART,
    MAX(CASE WHEN p.PAGE_NAME = 'faq' THEN TRUE ELSE FALSE END) AS VISITED_FAQ,
    MAX(CASE WHEN p.PAGE_NAME = 'plant_care' THEN TRUE ELSE FALSE END) AS VISITED_PLANT_CARE,
    MAX(CASE WHEN p.PAGE_NAME = 'landing_page' THEN TRUE ELSE FALSE END) AS VISITED_LANDING_PAGE
FROM {{ref("base_snowflake_SESSIONS")}} AS s
LEFT JOIN {{ref("base_snowflake_ORDERS")}} AS o ON s.SESSION_ID = o.SESSION_ID
LEFT JOIN {{ref("base_snowflake_ITEM_VIEWS")}} AS i ON s.SESSION_ID = i.SESSION_ID
LEFT JOIN {{ref('base_snowflake_PAGE_VIEWS')}} AS p ON s.SESSION_ID = p.SESSION_ID
WHERE s.SESSION_ID IS NOT NULL
GROUP BY s.SESSION_ID


